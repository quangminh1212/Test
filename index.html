<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tìm kiếm tần suất từ - Streaming</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
      .wrap { max-width: 720px; margin: 0 auto; }
      .row { display: flex; gap: 8px; }
      input[type="text"] { flex: 1; padding: 8px 10px; font-size: 16px; }
      button { padding: 8px 12px; font-size: 16px; }
      .status { margin-top: 1rem; padding: 0.5rem 0.75rem; background: #f5f5f5; border-radius: 6px; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
      .muted { color: #666; font-size: 14px; }
      .log { margin-top: 0.5rem; max-height: 200px; overflow: auto; background: #fff; border: 1px solid #eee; padding: 8px; }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  </head>
  <body>
    <div class="wrap">
      <h1>Tìm kiếm tần suất từ</h1>
      <p class="muted">Nhập một từ (chính xác, phân tách theo dấu phẩy trong file) và xem kết quả cập nhật mỗi 5 giây.</p>
      <div id="app"></div>
    </div>

    <script type="text/javascript">
      (function () {
        const e = React.createElement;

        function App() {
          const [term, setTerm] = React.useState("");
          const [count, setCount] = React.useState(null);
          const [status, setStatus] = React.useState("idle"); // idle | running | done | error
          const [processed, setProcessed] = React.useState(0);
          const [totalFiles, setTotalFiles] = React.useState(0);
          const [log, setLog] = React.useState([]);
          const evtRef = React.useRef(null);

          React.useEffect(() => {
            return () => { if (evtRef.current) evtRef.current.close(); };
          }, []);

          const startSearch = () => {
            if (!term) { alert('Vui lòng nhập từ cần tìm'); return; }
            if (evtRef.current) { evtRef.current.close(); }
            setCount(0);
            setStatus('running');
            setProcessed(0);
            setTotalFiles(0);
            setLog([]);
            const url = '/search-stream?term=' + encodeURIComponent(term);
            const es = new EventSource(url);
            evtRef.current = es;

            es.addEventListener('started', (e2) => {
              try {
                const data = JSON.parse(e2.data);
                setTotalFiles(data.totalFiles || 0);
                setLog((L) => L.concat('[started] totalFiles=' + data.totalFiles));
              } catch (_) {}
            });

            es.addEventListener('progress', (e2) => {
              try {
                const data = JSON.parse(e2.data);
                setCount(data.count || 0);
                setProcessed(data.processedFiles || 0);
              } catch (_) {}
            });

            es.addEventListener('done', (e2) => {
              try {
                const data = JSON.parse(e2.data);
                setCount(data.count || 0);
                setStatus('done');
                setLog((L) => L.concat('[done] count=' + data.count));
              } catch (_) {}
              es.close();
              evtRef.current = null;
            });

            es.addEventListener('error', (e2) => {
              try {
                const data = JSON.parse(e2.data);
                setLog((L) => L.concat('[error] ' + data.message));
              } catch (_) {}
              setStatus('error');
            });

            es.onerror = function () {
              setLog((L) => L.concat('[sse error] connection issue'));
            };
          };

          return e('div', null,
            e('div', { className: 'row' },
              e('input', {
                type: 'text',
                placeholder: 'Ví dụ: apple',
                value: term,
                onChange: (ev) => setTerm(ev.target.value),
                onKeyDown: (ev) => { if (ev.key === 'Enter') startSearch(); }
              }),
              e('button', { onClick: startSearch, disabled: status === 'running' }, 'Search')
            ),
            e('div', { className: 'status' },
              e('div', null, 'Trạng thái: ', e('strong', null, status)),
              e('div', null, 'Kết quả tạm thời mỗi 5s: ', e('span', { className: 'mono' }, (count == null ? '-' : String(count)))) ,
              e('div', null, 'Tệp đã xử lý: ', e('span', { className: 'mono' }, processed + '/' + totalFiles))
            ),
            e('div', { className: 'log' },
              log.map((line, idx) => e('div', { key: idx, className: 'mono' }, line))
            )
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(e(App));
      })();
    </script>
  </body>
</html>

